name: Release docker image

on:
  push:
    branches:
      - '*'
    tags:
      - 'v*.*.*'
      - 'v*.*.*-dev'

jobs:
  image-tags:
      name: 🐳 set image tags
      runs-on: ubuntu-20.04
      if: contains(github.ref, 'tags')
      steps:
        - name: Set release tag variable
          id: releaseTag
          shell: bash
          run: |
            # include git tag
            IMAGE_TAGS=$(echo "$GITHUB_REF" | awk -F'/' '{print $3}')
            # include branch name, commit sha
            IMAGE_TAGS="${IMAGE_TAGS},${GITHUB_REF_NAME},${GITHUB_SHA}"
            if [[ "$GITHUB_REF" =~ ^refs/tags/v*.*.*-dev ]]; then
              # a development release does not include the 'latest' tag
              echo -n "${IMAGE_TAGS}" >> TAGS.csv
            else
              echo -n "${IMAGE_TAGS},latest" >> TAGS.csv
            fi

  build-publish-image:
      name: 🐳 container-push
      needs: image-tags
      push: false
      uses: joelrebel/container-push/.github/workflows/container-push.yml@multiple-tags
      with:
        name: ironlib
        tag: $(cat TAGS.csv)
        dockerfile_path: Dockerfile
